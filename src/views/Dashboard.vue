<template>
  <div class="px-4 py-6">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <div class="mb-6">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md border border-blue-100 transition-all duration-300 hover:shadow-lg">
        <div class="px-5 py-4">
          <h1 class="text-2xl font-semibold text-indigo-900 mb-3 animate-pulse">
            åä¸ºåº”ç”¨å¸‚åœºçœ‹æ¿ æ•°æ®æ”¶é›†è‡ª appgallery api ä¸ä¿è¯æ¥æºçš„å‡†ç¡®æ€§ã€å®Œæ•´æ€§å’ŒçœŸå®æ€§ ä»…ä¾›å‚è€ƒ
          </h1>
          <div class="flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-4">
            <div class="flex flex-wrap justify-start items-center gap-1 sm:gap-3 w-full sm:w-auto">
              <button @click="refreshData" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 text-white text-sm font-medium rounded-md hover:from-cyan-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                  </path>
                </svg>
                åˆ·æ–°æ•°æ®
              </button>
              <button @click="$router.push('/help')" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-emerald-500 to-green-600 text-white text-sm font-medium rounded-md hover:from-emerald-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                  </path>
                </svg>
                å¸®åŠ©ä¿¡æ¯
              </button>
              <button @click="$router.push('/contact')" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-sm font-medium rounded-md hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                  </path>
                </svg>
                é—®é¢˜åé¦ˆ&äº¤æµ
              </button>
              <button @click="$router.push('/submit')" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-orange-500 to-yellow-600 text-white text-sm font-medium rounded-md hover:from-orange-600 hover:to-yellow-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                æŠ•ç¨¿
              </button>
            </div>
            <span class="text-gray-500 text-sm">æœ€åæ›´æ–°: <span>{{ lastUpdate }}</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-gradient-to-br from-rose-50 to-pink-50 rounded-lg shadow-md border border-rose-100 p-6 text-center transition-all duration-300 hover:shadow-lg hover:translate-y-[-5px]">
        <div class="py-3">
          <h5 class="text-rose-600 text-sm font-medium">å·²çˆ¬å–æ€»æ•°</h5>
          <h3 class="text-2xl font-bold text-rose-800 transition-all duration-500 hover:text-rose-600">
            {{ stats.app_count.total || 0 }}
          </h3>
        </div>
      </div>
      <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg shadow-md border border-orange-100 p-6 text-center transition-all duration-300 hover:shadow-lg hover:translate-y-[-5px]">
        <div class="py-3">
          <h5 class="text-amber-600 text-sm font-medium">åº”ç”¨æ€»æ•°</h5>
          <h3 class="text-2xl font-bold text-amber-800 transition-all duration-500 hover:text-amber-600">
            {{ stats.app_count.apps || 0 }}
          </h3>
        </div>
      </div>
      <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg shadow-md border border-emerald-100 p-6 text-center transition-all duration-300 hover:shadow-lg hover:translate-y-[-5px]">
        <div class="py-3">
          <h5 class="text-emerald-600 text-sm font-medium">å…ƒæœåŠ¡æ€»æ•°</h5>
          <h3 class="text-2xl font-bold text-emerald-800 transition-all duration-500 hover:text-emerald-600">
            {{ stats.app_count.atomic_services || 0 }}
          </h3>
        </div>
      </div>
      <div class="bg-gradient-to-br from-indigo-50 to-violet-50 rounded-lg shadow-md border border-indigo-100 p-6 text-center transition-all duration-300 hover:shadow-lg hover:translate-y-[-5px]">
        <div class="py-3">
          <h5 class="text-indigo-600 text-sm font-medium">å¼€å‘è€…æ€»æ•°</h5>
          <h3 class="text-2xl font-bold text-indigo-800 transition-all duration-500 hover:text-indigo-600">
            {{ stats.developer_count || 0 }}
          </h3>
        </div>
      </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 transition-all duration-300 hover:shadow-lg">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">ä¸‹è½½é‡æ’åå‰20çš„åº”ç”¨</h3>
          <div class="chart-container" style="height: 300px;">
            <canvas id="topDownloadChart"></canvas>
          </div>
        </div>
      </div>
      <div>
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 transition-all duration-300 hover:shadow-lg">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">åº”ç”¨è¯„åˆ†åˆ†å¸ƒ</h3>
          <div class="chart-container" style="height: 300px;">
            <canvas id="starChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- éåä¸ºåº”ç”¨ä¸‹è½½é‡æ’å -->
    <div class="mb-6">
      <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 transition-all duration-300 hover:shadow-lg">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">éåä¸ºåº”ç”¨ä¸‹è½½é‡æ’åå‰30</h3>
        <div class="chart-container" style="height: 300px;">
          <canvas id="nonHuaweiDownloadChart"></canvas>
        </div>
      </div>
    </div>

    <!-- åº”ç”¨åˆ—è¡¨åŠæœç´¢åŠŸèƒ½ -->
    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg shadow-md border border-amber-100 mb-6 transition-all duration-300 hover:shadow-lg">
      <div class="p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h5 class="text-lg font-semibold text-amber-800 mb-0">åº”ç”¨åˆ—è¡¨ (æ–½å·¥ä¸­, åŠŸèƒ½å¯èƒ½å‡ºç° bug)</h5>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto">
            <button @click="showSearchHelp = true" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-white text-sm font-medium rounded-md hover:from-amber-600 hover:to-yellow-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md"
              title="æœç´¢å¸®åŠ©">æœç´¢åŠŸèƒ½å¸®åŠ©</button>
            <input 
              type="text" 
              v-model="searchValue" 
              @keyup.enter="searchApps"
              class="flex-1 min-w-0 px-3 py-2 border border-amber-200 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-amber-500 focus:border-amber-500 text-sm bg-amber-50 placeholder-amber-400" 
              placeholder="æœç´¢åº”ç”¨"
            >
            <select 
              v-model="searchKey" 
              class="px-3 py-2 border border-amber-200 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-amber-500 focus:border-amber-500 text-sm bg-amber-50 text-amber-700"
            >
              <option value="name" selected>åº”ç”¨åç§°</option>
              <option value="pkg_name">åŒ…å</option>
              <option value="app_id">åº”ç”¨ ID</option>
              <option value="developer_name">å¼€å‘è€…åç§°</option>
              <option value="developer_en_name">å¼€å‘è€…è‹±æ–‡åç§°</option>
            </select>
            <label class="relative inline-flex items-center cursor-pointer">
              <input 
                type="checkbox" 
                v-model="searchExact" 
                class="sr-only peer"
              >
              <span class="ml-1 text-sm font-medium text-amber-700">ç²¾ç¡®åŒ¹é…</span>
              <div
                class="ml-2 relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600">
              </div>
            </label>
            <button 
              @click="searchApps"
              class="px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-white text-sm font-medium rounded-md hover:from-amber-600 hover:to-yellow-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md"
            >
              æœç´¢
            </button>
          </div>
        </div>
        
        <!-- åº”ç”¨è¡¨æ ¼ -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-amber-200">
            <thead class="bg-gradient-to-r from-amber-100 to-yellow-100">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-medium text-amber-700 uppercase tracking-wider">åºå·</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-amber-700 uppercase tracking-wider">åº”ç”¨åç§°</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider">å¼€å‘è€…</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider">åˆ†ç±»</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider">è¯„åˆ†</th>
                <th 
                  @click="sortApps('total_star_rating_count')"
                  class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider cursor-pointer transition-all duration-200 hover:bg-amber-200"
                >
                  è¯„åˆ†æ•°é‡ 
                  <span v-if="currentSort.field === 'total_star_rating_count'" class="ml-1 text-amber-500 font-bold">
                    {{ currentSort.desc ? 'â†“' : 'â†‘' }}
                  </span>
                </th>
                <th 
                  @click="sortApps('download_count')"
                  class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider cursor-pointer transition-all duration-200 hover:bg-amber-200"
                >
                  ä¸‹è½½é‡ 
                  <span v-if="currentSort.field === 'download_count'" class="ml-1 text-amber-500 font-bold">
                    {{ currentSort.desc ? 'â†“' : 'â†‘' }}
                  </span>
                </th>
                <th 
                  @click="sortApps('size_bytes')"
                  class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider cursor-pointer transition-all duration-200 hover:bg-amber-200"
                >
                  å¤§å° 
                  <span v-if="currentSort.field === 'size_bytes'" class="ml-1 text-amber-500 font-bold">
                    {{ currentSort.desc ? 'â†“' : 'â†‘' }}
                  </span>
                </th>
                <th 
                  @click="sortApps('metrics_created_at')"
                  class="px-6 py-3 text-left text-xs font-medium text-amber-700 uppercase tracking-wider cursor-pointer transition-all duration-200 hover:bg-amber-200"
                >
                  ä¸Šæ¬¡æ•°æ®æ›´æ–° 
                  <span v-if="currentSort.field === 'metrics_created_at'" class="ml-1 text-amber-500 font-bold">
                    {{ currentSort.desc ? 'â†“' : 'â†‘' }}
                  </span>
                </th>
              </tr>
            </thead>
            <tbody id="appTableBody" class="bg-gradient-to-r from-amber-50 to-yellow-50 divide-y divide-amber-100">
              <tr v-if="loadingApps">
                <td colspan="9" class="text-center py-12">
                  <div class="inline-block w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
                </td>
              </tr>
              <tr v-else-if="apps.length === 0">
                <td colspan="9" class="text-center py-8 text-gray-500">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åº”ç”¨</td>
              </tr>
              <tr v-else v-for="(app, index) in apps" :key="app[0].app_id" class="hover:bg-amber-100/50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">{{ (currentPage - 1) * PAGE_SIZE + index + 1 }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <img :src="app[0].icon_url" alt="åº”ç”¨å›¾æ ‡" class="w-8 h-8 rounded mr-2" @error="handleImageError($event)">
                    <div @click="goToAppDetail(app[0].app_id)" class="text-sm font-medium text-blue-600 cursor-pointer hover:underline">
                      {{ app[0].name?.length > 15 ? app[0].name.slice(0, 15) + '...' : app[0].name }}
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">{{ app[0].developer_name || 'æœªçŸ¥' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">{{ app[0].category || 'æœªçŸ¥' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">
                  <div class="flex items-center">
                    <span class="star-rating">â˜…</span>
                    <span class="ml-1">{{ app[1].average_star_rating ? app[1].average_star_rating.toFixed(1) : 'æ— ' }}</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">{{ formatNumber(app[1].total_star_rating_count || 0) }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">{{ formatNumber(app[1].download_count || 0) }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">{{ formatFileSize(app[1].size_bytes || 0) }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-700">
                  {{ app[1].metrics_created_at ? new Date(app[1].metrics_created_at).toLocaleString() : 'æœªçŸ¥' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="Page navigation" class="mt-6" v-if="totalPages > 1">
          <ul class="flex justify-center space-x-2">
            <li>
              <button 
                @click="changePage(1)"
                :disabled="currentPage === 1"
                class="px-3 py-1 border border-amber-300 rounded-md text-amber-700 hover:bg-amber-100 disabled:opacity-50"
              >
                é¦–é¡µ
              </button>
            </li>
            <li>
              <button 
                @click="changePage(currentPage - 1)"
                :disabled="currentPage === 1"
                class="px-3 py-1 border border-amber-300 rounded-md text-amber-700 hover:bg-amber-100 disabled:opacity-50"
              >
                ä¸Šä¸€é¡µ
              </button>
            </li>
            <li v-for="page in visiblePages" :key="page">
              <button 
                @click="changePage(page)"
                :class="currentPage === page ? 'bg-amber-500 text-white' : 'text-amber-700 hover:bg-amber-100'"
                class="px-3 py-1 border border-amber-300 rounded-md"
              >
                {{ page }}
              </button>
            </li>
            <li>
              <button 
                @click="changePage(currentPage + 1)"
                :disabled="currentPage === totalPages"
                class="px-3 py-1 border border-amber-300 rounded-md text-amber-700 hover:bg-amber-100 disabled:opacity-50"
              >
                ä¸‹ä¸€é¡µ
              </button>
            </li>
            <li>
              <button 
                @click="changePage(totalPages)"
                :disabled="currentPage === totalPages"
                class="px-3 py-1 border border-amber-300 rounded-md text-amber-700 hover:bg-amber-100 disabled:opacity-50"
              >
                æœ«é¡µ
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <!-- æœç´¢å¸®åŠ©å¼¹çª— -->
    <div v-if="showSearchHelp" class="fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-50 backdrop-blur-sm transition-opacity duration-300">
      <div class="relative top-8 mx-auto p-5 border border-amber-200 w-11/12 md:w-11/12 lg:w-4/5 xl:w-3/4 shadow-lg rounded-md bg-gradient-to-r from-amber-50 to-yellow-50 max-h-[90vh] overflow-y-auto transition-transform duration-300 transform">
        <div class="mt-3">
          <div class="flex justify-between items-center">
            <h5 class="text-lg font-semibold text-amber-800 bg-gradient-to-r from-amber-200 to-yellow-200 px-4 py-2 rounded-lg shadow-sm">
              æœç´¢åŠŸèƒ½å¸®åŠ©</h5>
            <button type="button" @click="showSearchHelp = false" class="text-amber-400 hover:text-amber-600 transition-all duration-300 transform hover:rotate-180">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div class="my-4 space-y-6">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg shadow-sm border border-blue-100">
              <h6 class="text-md font-semibold text-blue-800 mb-2">ğŸ” æœç´¢ç±»åˆ«è¯´æ˜</h6>
              <ul class="text-blue-700 text-sm space-y-2">
                <li><strong>åº”ç”¨åç§°</strong> (name): æœç´¢åº”ç”¨çš„æ˜¾ç¤ºåç§°ï¼Œå¦‚ "å¾®ä¿¡"ã€‚</li>
                <li><strong>åŒ…å</strong> (pkg_name): æœç´¢åº”ç”¨çš„å”¯ä¸€åŒ…æ ‡è¯†ç¬¦ï¼Œå¦‚ "com.tencent.mm"ã€‚</li>
                <li><strong>åº”ç”¨ ID</strong> (app_id): æœç´¢åä¸ºåº”ç”¨å¸‚åœºçš„åº”ç”¨å”¯ä¸€ IDã€‚</li>
                <li><strong>å¼€å‘è€…åç§°</strong> (developer_name): æœç´¢ä¸­æ–‡å¼€å‘è€…åç§°ã€‚</li>
                <li><strong>å¼€å‘è€…è‹±æ–‡åç§°</strong> (developer_en_name): æœç´¢è‹±æ–‡å¼€å‘è€…åç§°ã€‚</li>
              </ul>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg shadow-sm border border-green-100">
              <h6 class="text-md font-semibold text-emerald-800 mb-2">âš¡ ç²¾ç¡®åŒ¹é…å¼€å…³</h6>
              <p class="text-emerald-700 text-sm">
                <strong>å¼€å¯ (å‹¾é€‰)</strong>: è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼Œåªè¿”å›å®Œå…¨åŒ¹é…å…³é”®è¯çš„ç»“æœã€‚<br>
                <strong>å…³é—­ (æœªå‹¾é€‰)</strong>: è¿›è¡Œæ¨¡ç³Šæœç´¢ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼Œæé«˜æœç´¢çµæ´»æ€§ã€‚<br> é»˜è®¤å…³é—­ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰ã€‚
              </p>
            </div>
          </div>
        </div>
        <div class="flex justify-end pt-2">
          <button @click="showSearchHelp = false" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-white text-base font-medium rounded-md shadow-sm hover:from-amber-600 hover:to-yellow-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105 hover:shadow-md">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import { useRouter } from 'vue-router';
import Chart from 'chart.js/auto';
import { formatNumber } from '../utils';

// å®šä¹‰ç»Ÿè®¡æ•°æ®ç±»å‹
interface Stats {
    app_count: {
      total: number;
      apps: number;
      atomic_services: number;
    };
    developer_count: number
}

// å®šä¹‰åº”ç”¨æ•°æ®ç±»å‹
interface AppItem {
  [0]: {
    name: string;
    icon_url: string;
    app_id: string;
    developer_name?: string;
    category?: string;
  };
  [1]: {
    download_count: number;
    average_star_rating?: number;
    total_star_rating_count?: number;
    size_bytes?: number;
    metrics_created_at?: string;
  }
}

// åˆ†é¡µé…ç½®
const PAGE_SIZE = 10;

// çŠ¶æ€å®šä¹‰
const stats = ref<Stats>({
  app_count: {
    total: 0,
    apps: 0,
    atomic_services: 0,
  },
  developer_count: 0
});
const lastUpdate = ref<string>('');
const router = useRouter();
const preloadedImages = ref<{[key: string]: HTMLImageElement}>({});
const API_BASE = '/api';

// æœç´¢ç›¸å…³çŠ¶æ€
const searchValue = ref('');
const searchKey = ref('name');
const searchExact = ref(false);
const showSearchHelp = ref(false);

// åº”ç”¨åˆ—è¡¨ç›¸å…³çŠ¶æ€
const apps = ref<AppItem[]>([]);
const loadingApps = ref(true);
const currentPage = ref(1);
const totalPages = ref(1);
const currentSort = ref({
  field: 'download_count',
  desc: true
});

// åˆ·æ–°æ•°æ®
const refreshData = async () => {
  try {
    // é‡ç½®åº”ç”¨åˆ—è¡¨çŠ¶æ€
    currentPage.value = 1;
    totalPages.value = 1;
    
    // åŠ è½½æ¦‚è§ˆå’Œå›¾è¡¨
    await loadOverview();
    await loadCharts();
    
    // åŠ è½½åº”ç”¨åˆ—è¡¨
    await loadApps();
    
    // æ›´æ–°æ—¶é—´
    updateLastUpdate();
  } catch (error) {
    console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
  }
};

// åŠ è½½æ¦‚è§ˆç»Ÿè®¡
const loadOverview = async () => {
  try {
    const response = await fetch(`${API_BASE}/market_info`);
    const data = await response.json();
    if (data.success) {
      stats.value = data.data;
    }
  } catch (error) {
    console.error('åŠ è½½æ¦‚è§ˆç»Ÿè®¡å¤±è´¥:', error);
  }
};

// æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
const updateLastUpdate = () => {
  lastUpdate.value = new Date().toLocaleString('zh-CN');
};

// é¢„åŠ è½½åº”ç”¨å›¾æ ‡
const preloadAppImages = async (apps: AppItem[]) => {
  const images: {[key: string]: HTMLImageElement} = {};
  const loadPromises = apps.map((app) => {
    return new Promise<void>((resolve) => {
      const appId = app[0].app_id;
      const iconUrl = app[0].icon_url;
      
      if (!iconUrl) {
        images[appId] = null as unknown as HTMLImageElement;
        resolve();
        return;
      }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        images[appId] = img;
        resolve();
      };
      img.onerror = () => {
        images[appId] = null as unknown as HTMLImageElement;
        resolve();
      };
      img.src = iconUrl;
    });
  });

  await Promise.all(loadPromises);
  return images;
};

// åŠ è½½å›¾è¡¨
const loadCharts = async () => {
  try {
    // ä¸‹è½½é‡æ’åå›¾è¡¨
    const topDownloads = await fetch(`${API_BASE}/rankings/top-downloads?limit=20`);
    const topData = await topDownloads.json();
    if (topData.success) {
      const images = await preloadAppImages(topData.data as AppItem[]);
      preloadedImages.value = {...preloadedImages.value, ...images};
      renderTopDownloadChart(topData.data as AppItem[]);
    }

    // æ˜Ÿçº§åˆ†å¸ƒå›¾è¡¨
    const starDistribution = await fetch(`${API_BASE}/charts/star-distribution`);
    const starData = await starDistribution.json();
    if (starData.success) {
      renderStarChart(starData.data);
    }

    // éåä¸ºåº”ç”¨å›¾è¡¨
    const nonHuawei = await fetch(`${API_BASE}/rankings/top-downloads?limit=30&exclude_pattern=huawei`);
    const nonHuaweiData = await nonHuawei.json();
    if (nonHuaweiData.success) {
      const images = await preloadAppImages(nonHuaweiData.data as AppItem[]);
      preloadedImages.value = {...preloadedImages.value, ...images};
      renderNonHuaweiChart(nonHuaweiData.data as AppItem[]);
    }
  } catch (error) {
    console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
  }
};

// æ¸²æŸ“ä¸‹è½½é‡æ’åå›¾è¡¨ï¼ˆå¸¦å›¾æ ‡ï¼‰
const renderTopDownloadChart = (data: AppItem[]) => {
  const ctx = document.getElementById('topDownloadChart') as HTMLCanvasElement;
  
  // å›¾æ ‡ç»˜åˆ¶æ’ä»¶
  const iconPlugin = {
    id: 'iconPlugin',
    afterDatasetsDraw: (chart: any) => {
      const { ctx } = chart;
      const meta = chart.getDatasetMeta(0);
      
      meta.data.forEach((bar: any, index: number) => {
          const app = data[index];
          if (!app) return;
        const img = preloadedImages.value[app[0].app_id];
        if (!img) return;

        // è®¡ç®—å›¾æ ‡çš„ä½ç½®ï¼ˆåœ¨æŸ±å­é¡¶éƒ¨ï¼‰
        const x = bar.x;
        const y = bar.y - 17;
        
        // ç»˜åˆ¶å›¾æ ‡
        ctx.drawImage(img, x - 10, y - 20, 20, 20);
      });
    }
  };

  // ç‚¹å‡»äº‹ä»¶æ’ä»¶
  const clickPlugin = {
    id: 'clickPlugin',
    afterEvent: (chart: any, args: any) => {
      const { event } = args;
      if (event.type === 'click') {
        const elements = chart.getElementsAtEventForMode(
          event,
          'nearest', 
          { intersect: true },
          false
        );

        if (elements.length > 0) {
          const elementIndex = elements[0].index;
          const app = data[elementIndex];
          if (app && app[0].app_id) {
            router.push(`/app/${app[0].app_id}`);
          }
        }
      }
    }
  };

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(item => item[0].name?.length > 10 ? item[0].name.slice(0, 10) + '...' : item[0].name),
      datasets: [{
        label: 'ä¸‹è½½é‡',
        data: data.map(item => item[1].download_count || 0),
        backgroundColor: 'rgba(59, 130, 246, 0.6)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          ticks: {
                callback: (value: number | string) => {
                  if (typeof value === 'number') {
                      return formatNumber(value);
                  } else {
                      return value;
                  }
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: (context: any) => `ä¸‹è½½é‡: ${formatNumber(context.raw)}`
          }
        }
      }
    },
    plugins: [iconPlugin, clickPlugin]
  });
};

// æ¸²æŸ“æ˜Ÿçº§åˆ†å¸ƒå›¾è¡¨
const renderStarChart = (data: any) => {
  const ctx = document.getElementById('starChart') as HTMLCanvasElement;
  const starValues = [
    data.star_1 || 0,
    data.star_2 || 0,
    data.star_3 || 0,
    data.star_4 || 0,
    data.star_5 || 0
  ];

  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [
        `æ— è¯„åˆ† (${starValues[0]})`,
        `[1-2)æ˜Ÿ (${starValues[1]})`,
        `[2-3)æ˜Ÿ (${starValues[2]})`,
        `[3-4)æ˜Ÿ (${starValues[3]})`,
        `[4-5]æ˜Ÿ (${starValues[4]})`
      ],
      datasets: [{
        data: starValues,
        backgroundColor: [
          '#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
};

// æ¸²æŸ“éåä¸ºåº”ç”¨å›¾è¡¨ï¼ˆå¸¦å›¾æ ‡ï¼‰
const renderNonHuaweiChart = (data: AppItem[]) => {
  const ctx = document.getElementById('nonHuaweiDownloadChart') as HTMLCanvasElement;
  
  // å›¾æ ‡ç»˜åˆ¶æ’ä»¶
  const iconPlugin = {
    id: 'iconPlugin',
    afterDatasetsDraw: (chart: any) => {
      const { ctx } = chart;
      const meta = chart.getDatasetMeta(0);
      
      meta.data.forEach((bar: any, index: number) => {
          const app = data[index];
          if (!app) return;
        const img = preloadedImages.value[app[0].app_id];
        if (!img) return;

        // è®¡ç®—å›¾æ ‡çš„ä½ç½®ï¼ˆåœ¨æŸ±å­é¡¶éƒ¨ï¼‰
        const x = bar.x;
        const y = bar.y - 17;
        
        // ç»˜åˆ¶å›¾æ ‡
        ctx.drawImage(img, x - 10, y - 20, 20, 20);
      });
    }
  };

  // ç‚¹å‡»äº‹ä»¶æ’ä»¶
  const clickPlugin = {
    id: 'clickPlugin',
    afterEvent: (chart: any, args: any) => {
      const { event } = args;
      if (event.type === 'click') {
        const elements = chart.getElementsAtEventForMode(
          event,
          'nearest', 
          { intersect: true },
          false
        );

        if (elements.length > 0) {
          const elementIndex = elements[0].index;
          const app = data[elementIndex];
          if (app && app[0].app_id) {
            router.push(`/app/${app[0].app_id}`);
          }
        }
      }
    }
  };

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(item => item[0].name?.length > 10 ? item[0].name.slice(0, 10) + '...' : item[0].name),
      datasets: [{
        label: 'ä¸‹è½½é‡',
        data: data.map(item => item[1].download_count || 0),
        backgroundColor: 'rgba(16, 185, 129, 0.6)',
        borderColor: 'rgba(16, 185, 129, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          ticks: {
                callback: (value: number | string) => {
                if (typeof value === 'number') {
                      return formatNumber(value)
                } else {
                      return value;
                }
            }
          }
        }
      }
    },
    plugins: [iconPlugin, clickPlugin]
  });
};

// åŠ è½½åº”ç”¨åˆ—è¡¨
const loadApps = async () => {
  loadingApps.value = true;
  try {
    // æ„å»ºAPIè¯·æ±‚URL
    let url = `${API_BASE}/apps/list/${currentPage.value}?sort=${currentSort.value.field}&desc=${currentSort.value.desc}&page_size=${PAGE_SIZE}`;
    if (searchValue.value) {
      url += `&search_key=${encodeURIComponent(searchKey.value)}&search_value=${encodeURIComponent(searchValue.value)}&search_exact=${searchExact.value}`;
    }

    const response = await fetch(url);
    const data = await response.json();

    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    if (data.data && data.data.total_count) {
      totalPages.value = Math.ceil(data.data.total_count / PAGE_SIZE);
    }

    apps.value = data.data.data || [];
  } catch (error) {
    console.error('åŠ è½½åº”ç”¨åˆ—è¡¨å¤±è´¥:', error);
    apps.value = [];
  } finally {
    loadingApps.value = false;
  }
};

// æœç´¢åº”ç”¨
const searchApps = () => {
  currentPage.value = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
  loadApps();
};

// æ’åºåº”ç”¨
const sortApps = (field: string) => {
  // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºå­—æ®µï¼Œåˆ™åˆ‡æ¢æ’åºæ–¹å‘
  if (currentSort.value.field === field) {
    currentSort.value.desc = !currentSort.value.desc;
  } else {
    // å¦åˆ™è®¾ç½®æ–°çš„æ’åºå­—æ®µï¼Œé»˜è®¤é™åº
    currentSort.value = { field, desc: true };
  }
  currentPage.value = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
  loadApps();
};

// åˆ‡æ¢é¡µç 
const changePage = (page: number) => {
  if (page < 1 || page > totalPages.value) return;
  currentPage.value = page;
  loadApps();
};

// è®¡ç®—å¯è§é¡µç ï¼ˆç”¨äºåˆ†é¡µæ§ä»¶ï¼‰
const visiblePages = computed(() => {
  const pages = [];
  const maxVisible = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªé¡µç 

  // æ€»é¡µæ•°å°äºç­‰äºæœ€å¤§å¯è§æ•°ï¼Œç›´æ¥æ˜¾ç¤ºæ‰€æœ‰é¡µç 
  if (totalPages.value <= maxVisible) {
    for (let i = 1; i <= totalPages.value; i++) {
      pages.push(i);
    }
    return pages;
  }

  // æ€»é¡µæ•°å¤§äºæœ€å¤§å¯è§æ•°ï¼Œè®¡ç®—æ˜¾ç¤ºèŒƒå›´
  let start = Math.max(1, currentPage.value - Math.floor(maxVisible / 2));
  let end = start + maxVisible - 1;

  // è°ƒæ•´ç»“æŸé¡µç ä¸è¶…è¿‡æ€»é¡µæ•°
  if (end > totalPages.value) {
    end = totalPages.value;
    start = end - maxVisible + 1;
  }

  for (let i = start; i <= end; i++) {
    pages.push(i);
  }

  return pages;
});

// å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
const handleImageError = (event: Event) => {
  (event.target as HTMLImageElement).src = '/images/default-app-icon.png'; // æ›¿æ¢ä¸ºé»˜è®¤å›¾æ ‡
};

// è·³è½¬åˆ°åº”ç”¨è¯¦æƒ…é¡µ
const goToAppDetail = (appId: string) => {
  router.push(`/app/${appId}`);
};

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
const formatFileSize = (bytes: number) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
};

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
onMounted(() => {
  refreshData();
});
</script>

<style scoped>
.chart-container {
  height: 300px;
  position: relative;
  transition: all 0.3s ease;
  background-color: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  padding: 8px;
}

.star-rating {
  color: #ffcc00;
  text-shadow: 0px 0px 1px rgba(0, 0, 0, 0.2);
}

.app-icon {
  width: 32px;
  height: 32px;
}

.animate-spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>